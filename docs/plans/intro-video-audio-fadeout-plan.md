# Intro Video Audio Fade-Out Implementation Plan

## Overview
This document outlines the implementation plan for adding an audio fade-out effect to intro videos generated by the Veo API. The fade-out will gradually reduce the audio volume to zero during the last 1.5 seconds of the video, creating a smooth transition.

## Problem Statement
Currently, intro videos generated through the Veo API end abruptly with full volume audio. This creates a jarring experience when transitioning to the next segment of the presentation. A gradual audio fade-out would provide a more professional and polished viewing experience.

## Technical Solution

### FFmpeg Audio Filter
We will use FFmpeg's `afade` filter to apply the audio fade-out effect. The filter allows precise control over:
- Fade type (in/out)
- Start time
- Duration
- Curve type (optional)

### Command Structure
```bash
# Basic command for audio fade-out
ffmpeg -i input.mp4 -c:v copy -af "afade=t=out:st=START_TIME:d=1.5" output.mp4

# Where:
# -c:v copy = Copy video stream without re-encoding (preserves quality and speed)
# -af = Audio filter
# afade=t=out = Audio fade out effect
# st=START_TIME = When to start the fade (calculated as duration - 1.5)
# d=1.5 = Duration of fade in seconds
```

### Duration Calculation
To fade out the last 1.5 seconds, we need to:
1. Get the total video duration using `ffprobe`
2. Calculate fade start time: `duration - 1.5`
3. Apply the fade filter with calculated start time

## Implementation Approaches

### Option 1: Process During Download (Recommended)
**Location**: `VeoApiService.downloadVideo()` method

**Workflow**:
1. Download video from Veo API to temporary file
2. Apply audio fade-out using FFmpeg
3. Save processed video to final storage location
4. Delete temporary file

**Pros**:
- Single processing step
- No need to reprocess existing videos
- Transparent to rest of the system

**Cons**:
- Slightly longer download process
- Requires FFmpeg on the server

### Option 2: Dedicated Post-Processing Service
**Location**: New `VideoPostProcessingService` class

**Workflow**:
1. Download video normally
2. Queue for post-processing
3. Apply fade-out asynchronously
4. Update file reference

**Pros**:
- Modular and reusable
- Can apply multiple effects
- Easier to test independently

**Cons**:
- Additional complexity
- Async processing considerations

### Option 3: On-Demand Processing
**Location**: During video serving/publishing

**Workflow**:
1. Check if processed version exists
2. If not, apply fade-out on the fly
3. Cache processed version

**Pros**:
- Flexibility to change parameters
- Original file preserved

**Cons**:
- Processing overhead on first request
- Storage for both versions

## Detailed Implementation (Option 1)

### 1. Add Configuration Properties
```properties
# application.properties
veo.video.audio.fade-out-duration=1.5
veo.video.audio.fade-out-enabled=true
veo.video.ffmpeg.path=/usr/local/bin/ffmpeg
veo.video.ffprobe.path=/usr/local/bin/ffprobe
```

### 2. Modify VeoApiService

#### Add Audio Processing Method
```java
private Path applyAudioFadeOut(Path inputPath, double fadeOutDuration) throws IOException {
    // Implementation details:
    // 1. Create temp output file
    // 2. Get video duration using ffprobe
    // 3. Calculate fade start time
    // 4. Execute ffmpeg command
    // 5. Replace input with processed file
    // 6. Return processed file path
}
```

#### Integration Point
In `downloadVideo()` method:
```java
// After downloading video
Path downloadedFile = downloadVideoFromUrl(videoUrl, tempFile);

// Apply audio fade-out if enabled
if (audioFadeOutEnabled) {
    downloadedFile = applyAudioFadeOut(downloadedFile, fadeOutDuration);
}

// Continue with existing storage logic
```

### 3. FFmpeg Execution
Use ZeroTurnaround zt-exec library for robust process execution:
```java
ProcessResult result = new ProcessExecutor()
    .command(ffmpegPath,
        "-i", inputPath.toString(),
        "-c:v", "copy",
        "-af", String.format("afade=t=out:st=%.2f:d=%.2f", fadeStart, fadeOutDuration),
        "-y",
        outputPath.toString())
    .timeout(ffmpegTimeoutSeconds, TimeUnit.SECONDS)
    .exitValues(0)
    .execute();
```

### 4. Error Handling
- Check FFmpeg availability on startup
- Fallback to original video if processing fails
- Log warnings but don't fail the entire process
- Validate output file exists and has reasonable size

## Testing Plan

### Unit Tests
1. Test duration calculation logic
2. Test FFmpeg command generation
3. Test error handling scenarios

### Integration Tests
1. Process sample video with fade-out
2. Verify audio levels at end of video
3. Confirm video stream unchanged
4. Test with videos of different durations

### Manual Testing
```bash
# Test command on existing intro video
ffmpeg -i intro_video_original.mp4 \
  -c:v copy \
  -af "afade=t=out:st=8.5:d=1.5" \
  intro_video_faded.mp4

# Verify audio fade using ffplay or media player
```

## Performance Considerations

### Processing Time
- Video copy (no re-encoding): ~1-2 seconds per video
- Audio processing only: Minimal overhead
- Total added time: 2-3 seconds per video

### Storage
- Temporary file during processing
- No permanent storage increase (replace original)

### CPU Usage
- Minimal (audio processing only)
- Video stream is copied, not re-encoded

## Rollback Plan

### Feature Flag
Use configuration property to enable/disable:
```properties
veo.video.audio.fade-out-enabled=false
```

### Backward Compatibility
- Existing videos remain unchanged
- New feature only affects newly generated videos
- Can be disabled without code changes

## Dependencies

### System Requirements
- FFmpeg 4.0+ installed on server
- ZeroTurnaround zt-exec library (Maven dependency)
- Sufficient temp storage for processing

### Installation
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# macOS
brew install ffmpeg

# Verify installation
ffmpeg -version
ffprobe -version
```

### Maven Dependency
```xml
<dependency>
    <groupId>org.zeroturnaround</groupId>
    <artifactId>zt-exec</artifactId>
    <version>1.12</version>
</dependency>
```

## Security Considerations

1. **Input Validation**: Validate video files before processing
2. **Command Injection**: zt-exec uses array arguments (no shell interpretation)
3. **Resource Limits**: zt-exec provides built-in timeout support
4. **Temp File Cleanup**: Ensure temporary files are deleted

## Monitoring & Logging

### Metrics to Track
- Processing success rate
- Average processing time
- FFmpeg errors
- Fallback usage

### Log Entries
```
INFO: Applying audio fade-out to intro video: {videoId}
INFO: Audio fade-out applied successfully in {duration}ms
WARN: Failed to apply audio fade-out, using original: {error}
ERROR: FFmpeg not available, skipping audio processing
```

## Future Enhancements

1. **Configurable Fade Curves**: Linear, logarithmic, exponential
2. **Video Fade**: Add visual fade-out to match audio
3. **Batch Processing**: Process multiple videos efficiently
4. **Preview Generation**: Create preview with fade effect
5. **Custom Fade Duration**: Per-video fade settings

## Implementation Timeline

### Phase 1: Core Implementation (4 hours)
- Add FFmpeg processing method
- Integrate with VeoApiService
- Basic error handling

### Phase 2: Configuration & Testing (2 hours)
- Add configuration properties
- Write unit tests
- Manual testing

### Phase 3: Production Readiness (2 hours)
- Logging and monitoring
- Documentation
- Deployment guide

**Total Estimated Time**: 8 hours

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| FFmpeg not installed | High | Check on startup, clear error message |
| Processing failure | Medium | Fallback to original video |
| Performance impact | Low | Process async if needed |
| Different audio formats | Low | FFmpeg handles most formats |

## Approval & Sign-off

- [ ] Technical approach approved
- [ ] Performance impact acceptable
- [ ] Rollback plan reviewed
- [ ] Security considerations addressed
- [ ] Timeline agreed upon

---

**Document Version**: 1.1
**Created**: 2025-09-26
**Updated**: 2025-09-26 - Changed to use zt-exec library instead of ProcessBuilder
**Author**: System Architect
**Status**: IMPLEMENTED
