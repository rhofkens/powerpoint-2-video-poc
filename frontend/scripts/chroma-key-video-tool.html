<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chroma Key Video Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        input[type="file"],
        input[type="color"],
        input[type="range"],
        select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        .range-value {
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .video-box {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
        }
        
        .video-box h3 {
            margin: 0 0 15px 0;
            color: #444;
            font-size: 16px;
        }
        
        video, canvas {
            width: 100%;
            height: auto;
            border-radius: 4px;
            background: #000;
        }
        
        .background-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .bg-option {
            width: 100%;
            height: 60px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .bg-option:hover {
            transform: scale(1.05);
        }
        
        .bg-option.active {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        
        .bg-image {
            background-size: cover;
            background-position: center;
        }
        
        .performance-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 6px;
            font-size: 14px;
            color: #0066cc;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #colorPicker {
            width: 50px;
            height: 40px;
            cursor: pointer;
        }
        
        .eyedropper-btn {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Browser-Based Chroma Key Video Tool</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="videoFile">Upload Video:</label>
                <input type="file" id="videoFile" accept="video/*">
            </div>
            
            <div class="control-group">
                <label for="colorPicker">Chroma Key Color:</label>
                <div class="color-picker-container">
                    <input type="color" id="colorPicker" value="#00ff00">
                    <button class="eyedropper-btn" onclick="pickColorFromVideo()">
                        ðŸŽ¯ Pick Color from Video
                    </button>
                </div>
            </div>
            
            <div class="control-group">
                <label for="tolerance">Color Tolerance:</label>
                <input type="range" id="tolerance" min="0" max="100" value="30">
                <div class="range-value"><span id="toleranceValue">30</span>%</div>
            </div>
            
            <div class="control-group">
                <label for="smoothing">Edge Smoothing:</label>
                <input type="range" id="smoothing" min="0" max="10" value="2">
                <div class="range-value"><span id="smoothingValue">2</span></div>
            </div>
            
            <div class="control-group">
                <label>Background Options:</label>
                <div class="background-options">
                    <div class="bg-option active" style="background: #ffffff" onclick="setBackground('color', '#ffffff', this)"></div>
                    <div class="bg-option" style="background: #000000" onclick="setBackground('color', '#000000', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)" onclick="setBackground('gradient', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" onclick="setBackground('gradient', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', this)"></div>
                    <div class="bg-option bg-image" style="background-image: url('data:image/svg+xml,%3Csvg width="100" height="60" xmlns="http://www.w3.org/2000/svg"%3E%3Cdefs%3E%3ClinearGradient id="sky" x1="0%25" y1="0%25" x2="0%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%2387CEEB"%2F%3E%3Cstop offset="100%25" style="stop-color:%23E0F6FF"%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Crect width="100" height="60" fill="url(%23sky)"%2F%3E%3Crect x="0" y="40" width="100" height="20" fill="%2390EE90"%2F%3E%3C%2Fsvg%3E')" onclick="setBackground('image', 'nature', this)"></div>
                </div>
                <input type="file" id="bgImageFile" accept="image/*" style="margin-top: 10px;">
            </div>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <h3>Original Video</h3>
                <video id="sourceVideo" controls crossorigin="anonymous"></video>
            </div>
            
            <div class="video-box">
                <h3>Chroma Key Result</h3>
                <canvas id="outputCanvas"></canvas>
            </div>
        </div>
        
        <div class="performance-info">
            <strong>Performance:</strong> <span id="fps">0</span> FPS | 
            <strong>Processing:</strong> <span id="processingTime">0</span>ms
        </div>
    </div>

    <script>
        let video = document.getElementById('sourceVideo');
        let canvas = document.getElementById('outputCanvas');
        let ctx = canvas.getContext('2d');
        let animationId = null;
        let chromaColor = { r: 0, g: 255, b: 0 };
        let currentBackground = { type: 'color', value: '#ffffff' };
        let backgroundImage = null;
        let lastTime = 0;
        let frameCount = 0;
        
        // Event listeners
        document.getElementById('videoFile').addEventListener('change', handleVideoUpload);
        document.getElementById('colorPicker').addEventListener('change', updateChromaColor);
        document.getElementById('tolerance').addEventListener('input', updateTolerance);
        document.getElementById('smoothing').addEventListener('input', updateSmoothing);
        document.getElementById('bgImageFile').addEventListener('change', handleBackgroundImage);
        
        function handleVideoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    startProcessing();
                });
            }
        }
        
        function updateChromaColor(e) {
            const hex = e.target.value;
            chromaColor = hexToRgb(hex);
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        function updateTolerance(e) {
            document.getElementById('toleranceValue').textContent = e.target.value;
        }
        
        function updateSmoothing(e) {
            document.getElementById('smoothingValue').textContent = e.target.value;
        }
        
        function setBackground(type, value) {
            currentBackground = { type, value };
            
            // Update active state
            document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'image' && value === 'nature') {
                // Create a simple nature scene
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 450;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Sky gradient
                const skyGradient = tempCtx.createLinearGradient(0, 0, 0, tempCanvas.height);
                skyGradient.addColorStop(0, '#87CEEB');
                skyGradient.addColorStop(1, '#E0F6FF');
                tempCtx.fillStyle = skyGradient;
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Ground
                tempCtx.fillStyle = '#90EE90';
                tempCtx.fillRect(0, tempCanvas.height * 0.7, tempCanvas.width, tempCanvas.height * 0.3);
                
                // Convert to image
                backgroundImage = new Image();
                backgroundImage.src = tempCanvas.toDataURL();
            }
        }
        
        function handleBackgroundImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    backgroundImage = new Image();
                    backgroundImage.src = event.target.result;
                    currentBackground = { type: 'image', value: 'custom' };
                    
                    // Update UI
                    document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('active'));
                };
                reader.readAsDataURL(file);
            }
        }
        
        function pickColorFromVideo() {
            if (!video.src) {
                alert('Please upload a video first!');
                return;
            }
            
            // Create temporary canvas to sample color
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            
            // Draw current frame
            tempCtx.drawImage(video, 0, 0);
            
            // Create overlay for color picking
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            overlay.style.cursor = 'crosshair';
            overlay.style.zIndex = '9999';
            
            const preview = document.createElement('canvas');
            preview.style.position = 'fixed';
            preview.style.left = '50%';
            preview.style.top = '50%';
            preview.style.transform = 'translate(-50%, -50%)';
            preview.style.maxWidth = '80%';
            preview.style.maxHeight = '80%';
            preview.style.border = '3px solid white';
            preview.style.borderRadius = '8px';
            preview.width = tempCanvas.width;
            preview.height = tempCanvas.height;
            const previewCtx = preview.getContext('2d');
            previewCtx.drawImage(tempCanvas, 0, 0);
            
            overlay.appendChild(preview);
            document.body.appendChild(overlay);
            
            preview.addEventListener('click', function(e) {
                const rect = preview.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) * (preview.width / rect.width));
                const y = Math.floor((e.clientY - rect.top) * (preview.height / rect.height));
                
                const imageData = tempCtx.getImageData(x, y, 1, 1);
                const pixel = imageData.data;
                
                chromaColor = { r: pixel[0], g: pixel[1], b: pixel[2] };
                const hexColor = rgbToHex(pixel[0], pixel[1], pixel[2]);
                document.getElementById('colorPicker').value = hexColor;
                
                document.body.removeChild(overlay);
            });
            
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }
        
        function startProcessing() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            processFrame();
        }
        
        function processFrame(currentTime) {
            const startTime = performance.now();
            
            // Calculate FPS
            if (currentTime - lastTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastTime = currentTime;
            }
            frameCount++;
            
            // Draw background
            if (currentBackground.type === 'color') {
                ctx.fillStyle = currentBackground.value;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (currentBackground.type === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                const matches = currentBackground.value.match(/rgb\(\d+,\s*\d+,\s*\d+\)|#[0-9a-f]{6}|[a-z]+/gi);
                if (matches && matches.length >= 2) {
                    gradient.addColorStop(0, matches[1]);
                    gradient.addColorStop(1, matches[2]);
                }
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (currentBackground.type === 'image' && backgroundImage) {
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            }
            
            // Create temporary canvas for chroma keying
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw video to temp canvas
            tempCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            const imageData = tempCtx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tolerance = parseInt(document.getElementById('tolerance').value);
            const smoothing = parseInt(document.getElementById('smoothing').value);
            
            // Process pixels
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Calculate color distance
                const distance = Math.sqrt(
                    Math.pow(r - chromaColor.r, 2) +
                    Math.pow(g - chromaColor.g, 2) +
                    Math.pow(b - chromaColor.b, 2)
                );
                
                // Make pixel transparent if within tolerance
                if (distance < tolerance * 2.55) {
                    data[i + 3] = 0; // Alpha channel
                } else if (smoothing > 0 && distance < (tolerance + smoothing) * 2.55) {
                    // Edge smoothing
                    const alpha = (distance - tolerance * 2.55) / (smoothing * 2.55);
                    data[i + 3] = Math.floor(255 * alpha);
                }
            }
            
            // Put processed image data back
            tempCtx.putImageData(imageData, 0, 0);
            
            // Draw processed video on top of background
            ctx.drawImage(tempCanvas, 0, 0);
            
            // Update processing time
            const processingTime = (performance.now() - startTime).toFixed(1);
            document.getElementById('processingTime').textContent = processingTime;
            
            animationId = requestAnimationFrame(processFrame);
        }
        
        // Pause processing when video is paused
        video.addEventListener('pause', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        });
        
        video.addEventListener('play', () => {
            if (!animationId) {
                startProcessing();
            }
        });
    </script>
</body>
</html>